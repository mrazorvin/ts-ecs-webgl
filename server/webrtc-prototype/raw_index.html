<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC</title>
  </head>
  <body>
    <script type="module">
      const config = { iceServers: [{ urls: "stun:stun.1.google.com:19302" }] };
      const peer = new RTCPeerConnection(config);
      const data_channel = peer.createDataChannel("chat", { negotiated: true, id: 0 });

      data_channel.onopen = () => console.log("chat channel opened");
      data_channel.onmessage = (event) => console.log(`chat new message`, JSON.parse(event.data));
      peer.oniceconnectionstatechange = () => console.log("candidate changes", peer.iceConnectionState);

      window.send = (message) => {
        console.warn("chat send", message);
        data_channel.send(message);
      };

      async function create_offer(peer) {
        await peer.setLocalDescription(await peer.createOffer());

        return new Promise((resolve) => {
          peer.onicecandidate = ({ candidate }) => {
            if (candidate) return;
            resolve(peer.localDescription.sdp);
          };
        });
      }

      async function create_answer(peer, offer) {
        await peer.setRemoteDescription({ type: "offer", sdp: offer });
        await peer.setLocalDescription(await peer.createAnswer());

        return new Promise((resolve) => {
          peer.onicecandidate = ({ candidate }) => {
            if (candidate) return;
            resolve(peer.localDescription.sdp);
          };
        });
      }

      const { offer, id } = await fetch("/offer").then((response) => response.json());

      async function connect() {
        const offer = await create_offer(peer);
        const source = new window.EventSource(`/?${JSON.stringify({ offer })}`);
        await new Promise((resolve) => {
          source.onmessage = async (message) => {
            try {
              if (!message || !message.data) return console.error("skipping empty message");
              const { answer } = JSON.parse(message.data);

              if (answer) {
                source.onmessage = undefined;
                await peer.setRemoteDescription({ type: "answer", sdp: answer });
                resolve(peer);
              }
            } catch (error) {
              console.error("invalid message", error);
            }
          };
        });
      }

      if (!offer) {
        await connect();
        console.log("peer-to-peer completed, initiator", peer);
        send(JSON.stringify("hi"));
      } else {
        const answer = await create_answer(peer, offer);
        await fetch("/answer", { method: "POST", body: JSON.stringify({ id, answer }) });
      }
    </script>
  </body>
</html>
